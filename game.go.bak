package main

import (
	"fmt"
	"os"

	rl "github.com/gen2brain/raylib-go/raylib"

	endingSC "example/depths/internal/screen/ending"
	gameplaySC "example/depths/internal/screen/gameplay"
	logoSC "example/depths/internal/screen/logo"
	optionsSC "example/depths/internal/screen/options"
	titleSC "example/depths/internal/screen/title"
)

// Copied and adapted from https://github.com/raysan5/raylib-game-template/blob/main/src/raylib_game.c

type GameScreen int

const (
	unknownGameScreen  GameScreen = iota - 1 // -1
	logoGameScreen                           // 0
	titleGameScreen                          // 1
	optionsGameScreen                        // 3
	gameplayGameScreen                       // 4
	endingGameScreen                         // 5
)

// Shared Variables Definition (global)

// NOTE: Those variables are shared between modules through C equivalent of screens.h
var (
	currentScreen GameScreen
	font          rl.Font
	music         rl.Music
	fxCoin        rl.Sound
)

// Local Variables Definition (local to this module)

// Required variables to manage screen transitions (fade-in, fade-out)
var (
	transAlpha      float32    = float32(0.0)
	onTransition    bool       = false
	transFadeout    bool       = false
	transFromScreen int        = -1
	transToScreen   GameScreen = unknownGameScreen
)

// //----------------------------------------------------------------------------------
// // Local Functions Declaration
// //----------------------------------------------------------------------------------
// static void ChangeToScreen(int screen);     // Change to screen, no transition effect
//
// static void TransitionToScreen(int screen); // Request transition to next screen
// static void UpdateTransition(void);         // Update transition effect
// static void DrawTransition(void);           // Draw transition effect (full-screen rectangle)
//
// static void UpdateDrawFrame(void);          // Update and draw one frame

// Main entry point
func run() {
	// Initialization
	rl.InitWindow(int32(rl.GetScreenWidth()), int32(rl.GetScreenHeight()), "tiny game â”€ depths")

	rl.InitAudioDevice()

	font = rl.GetFontDefault() // font = rl.LoadFont("res/mecha.png")
	// music = rl.LoadMusicStream("res/ambient.ogg")
	// fxCoin = rl.LoadSound("res/coin.wav")

	music = rl.LoadMusicStream("res/music/mini1111.xm")
	music.Looping = false
	// musicPitch = 1.0

	rl.SetMusicVolume(music, 1.0)
	rl.PauseMusicStream(music)

	currentScreen = logoGameScreen
	logoSC.Init()

	if _, ok := os.LookupEnv("PLATFORM_WEB"); ok {
		fmt.Printf("\"PLATFORM_\": %v\n", "PLATFORM_WEB")
		// emscripten_set_main_loop(UpdateDrawFrame, 60, 1)
	} else {
		rl.SetTargetFPS(60)

		// Main game loop
		for !rl.WindowShouldClose() {
			rl.UpdateMusicStream(music)
			UpdateDrawFrame()
		}
	}

	// De-Initialization

	// Unload current screen data before closing
	switch currentScreen {
	case logoGameScreen:
		logoSC.Unload()
	case titleGameScreen:
		titleSC.Unload()
	case optionsGameScreen:
		optionsSC.Unload()
	case gameplayGameScreen:
		gameplaySC.Unload()
	case endingGameScreen:
		endingSC.Unload()
	case unknownGameScreen:
		break
	default:
		panic(fmt.Sprintf("unexpected main.GameScreen: %#v", currentScreen))
	}

	// Unload global data loaded
	rl.UnloadFont(font)
	rl.UnloadMusicStream(music)
	// rl.UnloadSound(fxCoin)

	rl.CloseAudioDevice() // Close audio context

	rl.CloseWindow() // Close window and OpenGL context
}

// ChangeToScreen changes to next screen, no transition.
func ChangeToScreen(screen GameScreen) {

	// Unload current screen
	switch currentScreen {
	case logoGameScreen:
		logoSC.Unload()
	case titleGameScreen:
		titleSC.Unload()
	case optionsGameScreen:
		optionsSC.Unload()
	case gameplayGameScreen:
		gameplaySC.Unload()
	case endingGameScreen:
		endingSC.Unload()
	case unknownGameScreen:
		break
	default:
		panic(fmt.Sprintf("unexpected main.GameScreen: %#v", currentScreen))
	}

	// Init next screen
	switch screen {
	case logoGameScreen:
		logoSC.Init()
	case titleGameScreen:
		titleSC.Init()
	case optionsGameScreen:
		optionsSC.Init()
	case gameplayGameScreen:
		gameplaySC.Init()
	case endingGameScreen:
		endingSC.Init()
	case unknownGameScreen:
		break
	default:
		panic(fmt.Sprintf("unexpected main.GameScreen: %#v", currentScreen))
	}

	currentScreen = screen
}

// TransitionToScreen requests transition to next screen.
func TransitionToScreen(screen GameScreen) {
	onTransition = true
	transFadeout = false
	transFromScreen = int(currentScreen)
	transToScreen = screen
	transAlpha = float32(0.0)

}

// UpdateTransition updates transition effect (fade-in, fade-out).
func UpdateTransition() {
	if !transFadeout {
		transAlpha += 0.05

		if transAlpha > 1.01 {
			transAlpha = 1.0

			// Unload current screen
			switch GameScreen(transFromScreen) {
			case logoGameScreen:
				logoSC.Unload()
			case titleGameScreen:
				titleSC.Unload()
			case optionsGameScreen:
				optionsSC.Unload()
			case gameplayGameScreen:
				gameplaySC.Unload()
			case endingGameScreen:
				endingSC.Unload()
			case unknownGameScreen:
				break
			default:
				panic(fmt.Sprintf("unexpected main.GameScreen: %#v", currentScreen))
			}

			// Load next screen
			switch transToScreen {
			case logoGameScreen:
				logoSC.Init()
			case titleGameScreen:
				titleSC.Init()
			case optionsGameScreen:
				optionsSC.Init()
			case gameplayGameScreen:
				gameplaySC.Init()
			case endingGameScreen:
				endingSC.Init()
			case unknownGameScreen:
				break
			default:
				panic(fmt.Sprintf("unexpected main.GameScreen: %#v", currentScreen))
			}

			currentScreen = transToScreen

			// Activate fade out effect to next loaded screen
			transFadeout = true
		}
	} else { // Transition fade out logic
		transAlpha -= 0.02
		if transAlpha < -0.01 {
			onTransition = false
			transFadeout = false
			transFromScreen = int(GameScreen(-1))
			transToScreen = unknownGameScreen
			transAlpha = 0.0
		}
	}
}

// DrawTransition draws transition effect (full-screen rectangle).
func DrawTransition() {
	rl.DrawRectangle(0, 0, int32(rl.GetScreenWidth()),
		int32(rl.GetScreenHeight()), rl.Fade(rl.Black, transAlpha))
}

// UpdateDrawFrame  updates and draws game frame.
func UpdateDrawFrame() {
	// =============================================================================
	// Update

	if !onTransition {
		switch currentScreen {
		case logoGameScreen:
			logoSC.Update()

			if logoSC.Finish() == 1 {
				TransitionToScreen(titleGameScreen)
			}
		case titleGameScreen:
			titleSC.Update()

			if titleSC.Finish() == 1 {
				TransitionToScreen(optionsGameScreen)
			} else if titleSC.Finish() == 2 {
				TransitionToScreen(gameplayGameScreen)
			}
		case optionsGameScreen:
			optionsSC.Unload()

			if optionsSC.Finish() == 1 {
				TransitionToScreen(titleGameScreen)
			}
		case gameplayGameScreen:
			gameplaySC.Update()

			if gameplaySC.Finish() == 1 {
				TransitionToScreen(endingGameScreen)
			} else if gameplaySC.Finish() == 2 {
				TransitionToScreen(titleGameScreen)
			}
		case endingGameScreen:
			endingSC.Update()

			if endingSC.Finish() == 1 {
				TransitionToScreen(titleGameScreen)
			}
		case unknownGameScreen:
			break
		default:
			panic(fmt.Sprintf("unexpected main.GameScreen: %#v", currentScreen))
		}
	} else {
		UpdateTransition() // Update transition (fade-in, fade-out)
	}
	// -----------------------------------------------------------------------------

	// =============================================================================
	// Draw

	rl.BeginDrawing()

	rl.ClearBackground(rl.RayWhite)

	switch currentScreen {
	case logoGameScreen:
		logoSC.Draw()
	case titleGameScreen:
		titleSC.Draw()
	case optionsGameScreen:
		optionsSC.Draw()
	case gameplayGameScreen:
		gameplaySC.Draw()
	case endingGameScreen:
		endingSC.Draw()
	case unknownGameScreen:
		break
	default:
		panic(fmt.Sprintf("unexpected main.GameScreen: %#v", currentScreen))
	}

	// Draw full screen rectangle in front of everything
	if onTransition {
		DrawTransition()
	}

	// rl.DrawFPS(10, 10)

	rl.EndDrawing()
	// -----------------------------------------------------------------------------
}
